name: Workflow to run slurm jobs

on:
  workflow_call:

permissions:
  contents: read
  id-token: write

jobs:
  run-slurm-job:
    name: Submit a slurm job 
    runs-on: ubuntu-latest
    env:
      HOME: /home-mscluster/${{ secrets.USER }}

    steps:
      - name: SSH into login node and submit the job
        uses: appleboy/ssh-action@v1
        env: 
          GITHUB_SHA: ${{ github.sha }}
          PROJECT_ROOT: ${{ env.HOME }}/AdaptPolicies
          SLURM_SCRIPTS_PREFIX: ${{ env.HOME }}/AdaptPolicies/src/slurm-scripts
          SLURM_LOGS_PREFIX: ${{ env.HOME }}/slurm-logs
        with: 
          host: ${{ secrets.HOSTNAME }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.PRIVATE_KEY }}
          envs: HOME,PROJECT_ROOT,GITHUB_SHA,SLURM_SCRIPTS_PREFIX,SLURM_LOGS_PREFIX
          script: |
            echo '--- Syncing local repo ---'
            cd $PROJECT_ROOT
            git stash push -u -m "github-actions-$(date +%s)"
            git fetch origin
            git reset --hard $GITHUB_SHA
            
            for slurm_script in "$SLURM_SCRIPTS_PREFIX/*.slurm"; do
              echo "--- Found $slurm_script ---"
              if [ -f "$slurm_script" ]; then
                jobname=$(basename -- $slurm-script ".slurm") 
                jobdir=$SLURM_LOGS_PREFIX/${jobname}

                if [ ! -d "$jobdir" ]; then
                  echo '--- Creating job dir for $jobname ---'
                  mkdir $jobdir
                fi
                
                echo '--- Submitting job $jobname ---'
                sbatch $slurm-script
              fi
            done

